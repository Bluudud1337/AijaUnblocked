<!-- CHATROOM -->
<div id="chatroom" style="position:fixed;bottom:20px;right:20px;width:300px;height:400px;background:var(--background-color);border:2px solid var(--accent-color);border-radius:10px;display:flex;flex-direction:column;z-index:1003;">
    <div style="background:var(--accent-color);color:var(--text-color);padding:5px;text-align:center;font-weight:bold;">Aija Chat Room</div>
    <div id="chatMessages" style="flex:1;padding:5px;overflow-y:auto;font-size:14px;"></div>
    <input id="chatInput" placeholder="Type a message..." style="border:none;border-top:2px solid var(--accent-color);padding:5px;font-size:14px;color:var(--text-color);background:var(--background-color);outline:none;">
</div>

<script>
/* ==== USERNAME ==== */
let username = localStorage.getItem("chatUsername");
if(!username){
    username = prompt("Enter a username (no bad words!):") || "Guest";
    localStorage.setItem("chatUsername", username);
}

/* ==== MODERATION ==== */
const badWords = ["fuck","nigga","nigger","bitch","faggot"]; // replace with words you want to filter
function cleanMessage(msg){
    let clean = msg;
    badWords.forEach(word => {
        const regex = new RegExp(word,"gi");
        clean = clean.replace(regex,"***");
    });
    return clean;
}

/* ==== LOAD / SAVE MESSAGES ==== */
let chatMessagesArray = JSON.parse(localStorage.getItem("chatMessages")) || [];

/* ==== RENDER MESSAGES ==== */
const chatMessagesDiv = document.getElementById("chatMessages");
function renderMessages(){
    chatMessagesDiv.innerHTML = "";
    chatMessagesArray.forEach(m => {
        const div = document.createElement("div");
        div.innerHTML = `<strong style="color:var(--accent-color)">${m.username}</strong> [${m.time}]: ${m.message}`;
        chatMessagesDiv.appendChild(div);
    });
    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
}

/* ==== SEND MESSAGE ==== */
const chatInput = document.getElementById("chatInput");
chatInput.addEventListener("keydown", e => {
    if(e.key === "Enter" && chatInput.value.trim() !== ""){
        const msg = cleanMessage(chatInput.value.trim());
        const time = new Date().toLocaleTimeString();
        const messageObj = {username, message: msg, time};
        chatMessagesArray.push(messageObj);

        // Save to localStorage
        localStorage.setItem("chatMessages", JSON.stringify(chatMessagesArray));

        renderMessages();
        chatInput.value = "";
    }
});

/* ==== INITIAL RENDER ==== */
renderMessages();

/* ==== THEME INTEGRATION ==== */
function updateChatTheme(){
    document.getElementById("chatroom").style.background = getComputedStyle(document.documentElement).getPropertyValue('--background-color');
    document.getElementById("chatroom").style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
    chatInput.style.background = getComputedStyle(document.documentElement).getPropertyValue('--background-color');
    chatInput.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-color');
}
updateChatTheme();

/* Update chat theme when accent color or mode changes */
const observer = new MutationObserver(updateChatTheme);
observer.observe(document.documentElement, { attributes: true, attributeFilter: ['style','data-mode'] });
</script>

